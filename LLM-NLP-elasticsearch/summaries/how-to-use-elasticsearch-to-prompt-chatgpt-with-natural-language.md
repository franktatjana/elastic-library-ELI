
# How to use Elasticsearch to prompt ChatGPT with natural language


The [blog post](https://www.elastic.co/blog/elasticsearch-prompt-chatgpt-natural-language) describes how ability to generate code can be applied to generate Elasticsearch DSL queries. The goal is to search in Elasticsearch® with sentences like “Give me the first 10 documents of 2017 from the stocks index.”

---
**How to generate Elasticsearch DSL with ChatGPT?**
- use the GET /stocks/_mapping API to retrieve the mapping from Elasticsearch.
- prompt ```Given the mapping delimited by triple backticks ```{mapping}``` translate the text delimited by triple quotes in a valid Elasticsearch DSL query """{query}""". Give me only the json code part of the answer. Compress the json output removing spaces.```
   - replace {mapping}  with string returned by GET /stocks/_mapping
   - replace {query}  with a question expressed in human language (for example: Return the first 10 documents of 2017)
- iterate to avoid general or ambiguous replies
- test with https://www.dsltranslate.com/
---
**How to put all together?**
- [repository](https://github.com/elastic/elasticsearch-chatgpt-php), the inputs are index and prompt, the result is a mapping in JSON that is used to build the query string to send to ChatGPT
- to query Elasticsearch the official elastic/elasticsearch-php client is utilized
- to optimize response time and reduce the cost of using the ChatGPT API use
a simple caching system based on files
   - store the mapping JSON returned by Elasticsearch: file named after the index;
   - store the Elasticsearch DSL generated by ChatGPT: the cache file using the hash (MD5) of the prompt used
   - getLastQuery() function
---
**How to run an experiment with financial data?**
- ingest data from https://github.com/elastic/elasticsearch-php-examples/blob/main/data/all_stocks_5yr.csv
- set environment variables: openai api key, elastic cloud endpoint, elastic cloud api key
- run a simple PHP script for testing some query expressed in English https://github.com/elastic/elasticsearch-chatgpt-php/blob/main/examples/test.php
- test with the following requests:
   - Query: Return the first 30 names of all the different stock names
   - Query: Return the first 10 documents of 2017
   - Query: Return the max value of the field "high" for each stock in 2015
   - Query: Return the average value of the field "high" for each stock in 2015
   - Query: Return the max value of the field "high" for all the documents with name MON in 2014
   - Query: Return the documents that have the difference between close and open fields > 20
- test with diff languages:
   - $result = $chatGPT->search('stocks', 'Return the first 10 documents of 2017');
   - $result = $chatGPT->search('stocks', 'Senden Sie die ersten 10 Dokumente des Jahres 2017 zurück');
---
**What are the limitations and how to solve them?**
- LLMs are not capable of verifying the correctness of the answer --> use  using an external plugin, like the Wolfram Plugin of ChatGPT (https://www.wolfram.com/wolfram-plugin-chatgpt/).
-  lacking ability to translate a human sentence in an Elasticsearch DSL query --> rephrase the sentence using more specific information, removing the apparent ambiguity about the date format

